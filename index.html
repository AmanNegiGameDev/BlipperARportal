<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="shortcut icon" href="#" />
    <title>Blippar WebAR SDK - Portal with Landing Animation</title>

    <script src="https://ar-libs.blippar.com/aframe/1.3.0/aframe-v1.3.0.min.js"></script>
    <script src="https://ar-libs.blippar.com/components/aframe-extras/6.1.1/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>

    <!--Draco decoder scripts -->
    <script src="https://www.gstatic.com/draco/v1/decoders/draco_decoder.js"></script>
    <script src="https://www.gstatic.com/draco/v1/decoders/draco_wasm_wrapper.js"></script>

    <!-- WebAR SDK -->
    <script src="./webar-sdk/webar-sdk-v2.0.8.min.js"
            webar-mode="surface-tracking"
            auto-init="false"
            auto-start-tracking="true"></script>

    <!-- Animation Timeline Component -->
    <script src="https://unpkg.com/aframe-animation-timeline-component@2.0.0/dist/aframe-animation-timeline-component.min.js"></script>

    <!-- Landing Cursor Component -->
    <script>
      var portalObject = undefined;
      var portalHiderObject = undefined;

      AFRAME.registerComponent("landingcursor", {
        init: function() {
          WEBARSDK.SetStageReadyCallback(() => {
            console.log('Stage is ready now!!!');
            portalHiderObject = document.getElementById('portal_1');
            portalObject = document.getElementById('portal_2');
            this.el.emit('landit');
          });

          this.el.addEventListener("animationcomplete__cursorend", e => {
            portalHiderObject.setAttribute('visible', true);
            portalObject.setAttribute('visible', true);
            this.el.setAttribute('visible', false);
          });
        }
      });

      // Portal Entry Logic
      let closenessRatio = 0.25;
      WEBARSDK.SetPortalEntryCallback(() => {
        console.log("Entered the portal door");
        let enableGyroCam = true;
        WEBARSDK.DisableTracking(enableGyroCam);
        portalObject.object3D.position.set(0, 0, 3.0);
        portalHiderObject.object3D.position.set(0, 0, 3.0);
        console.log("Enabled gyro cam");
      }, closenessRatio);

      // Hider Material Component
      AFRAME.registerComponent("hider-material", {
        init: function () {
          this.el.addEventListener('model-loaded', this.update.bind(this));
        },
        update: function () {
          this.el.object3D.traverse(function (child) {
            if (child.isMesh) {
              child.material.colorWrite = false;
            }
          });
        }
      });
    </script>
</head>

<body>
    <a-scene
      webar-scene="key:e625be84-6c3e-4b10-8c61-f078b6a57f41"
      vr-mode-ui="enabled: false"
      animation-timeline__1="timeline: #landingTimeline; loop: false; startEvents: landit;">

      <a-camera webar-camera></a-camera>
      <a-camera webar-camera2 look-controls="enabled:true"></a-camera>

      <a-assets timeout="60000">
          <a-asset-item id="portalhider" src="models/portal-hider.glb"></a-asset-item>
          <a-asset-item id="portal" src="models/portal.glb"></a-asset-item>

          <!-- Landing Timeline -->
          <a-timeline id="landingTimeline">
            <a-timeline-animation select="#landing" name="cursorbegin"></a-timeline-animation>
            <a-timeline-animation select="#landing" name="cursorend"></a-timeline-animation>
          </a-timeline>

          <!-- Landing Effect Mixin -->
          <a-mixin id="landeffect"
            animation__cursorbegin="property: visible; from: false; to: true; dur: 1; autoplay: false"
            animation__cursorend="property: scale; to: 0.75 0.75 0.75; dur: 2000; easing: easeInOutElastic; autoplay: false"
            scale="0.0001 0.0001 0.0001"
            position="0 0 0"
            visible="false"></a-mixin>
      </a-assets>

      <a-entity id="deskenv" environment="preset: starry; groundColor: #222; gridColor: #f28500;"></a-entity>
      <a-light type="ambient" color="#ffffff"></a-light>

      <a-entity webar-stage position="0 1 -2">
        <!-- Landing Cursor Ring -->
        <a-ring landingcursor id="landing" mixin="landeffect" color="#FBB42C"
                material="opacity: 0.4; transparent: true" radius-inner="0.8" radius-outer="1"
                rotation="-90 0 0" segments-phi="30" segments-theta="96"></a-ring>

        <!-- Portal Models -->
        <a-entity gltf-model="#portalhider" id="portal_1" rotation="0 0 0" position="0 0 0" scale="3.0 3.0 3.0" webar-loadmonitor="elType: glb" hider-material></a-entity>
        <a-entity gltf-model="#portal" id="portal_2" rotation="0 0 0" position="0 0 0" scale="3.0 3.0 3.0" webar-loadmonitor="elType: glb"></a-entity>
      </a-entity>
    </a-scene>

    <script>
      WEBARSDK.Init();
      WEBARSDK.SetGuideViewCallbacks(() => console.log("Start guide"), () => console.log("Stop guide"));
      WEBARSDK.SetPrepareForCameraTransitionCallback(() => {
        document.getElementById('deskenv').remove();
      });
    </script>
</body>
</html>
